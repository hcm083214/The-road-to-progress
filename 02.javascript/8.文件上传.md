# ã€é¡¹ç›®æ€»ç»“ã€‘æ–‡ä»¶ä¸Šä¼ åŸç†åŠå¤šåœºæ™¯å®ç°

## æ–‡ä»¶ä¸Šä¼ çš„è¯·æ±‚ä½“

æ–‡ä»¶ä¸Šä¼ æœ¬è´¨ä¸Šä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨åç«¯æ¥å£ï¼Œé€šè¿‡ `http` è¯·æ±‚å°†äºŒè¿›åˆ¶æ–‡ä»¶ä¼ é€’ç»™åç«¯æœåŠ¡å™¨ï¼Œä¸€èˆ¬æ–‡ä»¶ä¸Šä¼ æ˜¯é€šè¿‡åˆ›å»º `FormData` å¯¹è±¡æ¥å®Œæˆã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¸Šä¼ æ¥å£ï¼š

```js
function upload(file, onProgress, onFinish) {
    const formData = new FormData();
    formData.append('fileChuck', file.fileChuck);
    formData.append('fileChuckHash', file.fileChuckHash);
    formData.append('fileHash', file.fileHash);
    formData.append('isCompleted',file.isCompleted)
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload');
    xhr.addEventListener("readystatechange", () => {
        if (xhr.readyState === 4 && xhr.status === 200) {
            onFinish(JSON.parse(xhr.responseText));
        }
    })
    xhr.addEventListener("progress", (e) => {
        let percent = (uploadCtr.index + e.loaded / e.total) / uploadCtr.total;
        onProgress(percent);
    })
    xhr.send(formData);
    return () => {
        xhr.abort();
    }
}
```

å½“å‘èµ·è¯·æ±‚åï¼Œ`http` è¯·æ±‚å¤´ä¼šè‡ªåŠ¨è®¾ç½® `Content-Type:multipart/form-data; boundary=----WebKitFormBoundary2u7XXrIsr7HuQMbH`ã€‚å…¶ä¸­ **`Content-Type`** ç”¨äºæŒ‡ç¤ºèµ„æºçš„ MIME ç±»å‹ï¼Œ `boundary` è¡¨ç¤ºåˆ†éš”ç¬¦

[å¸¸è§ MIME ç±»å‹åˆ—è¡¨ - HTTP | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types)

> MIME ç±»å‹å³**åª’ä½“ç±»å‹**ï¼ˆä¹Ÿé€šå¸¸ç§°ä¸º**å¤šç”¨é€”äº’è”ç½‘é‚®ä»¶æ‰©å±•**æˆ– **MIME** ç±»å‹ï¼‰æ˜¯ä¸€ç§æ ‡å‡†ï¼Œç”¨æ¥è¡¨ç¤ºæ–‡æ¡£ã€æ–‡ä»¶æˆ–ä¸€ç»„æ•°æ®çš„æ€§è´¨å’Œæ ¼å¼

è¯·æ±‚ä½“çš„æ ¼å¼å¦‚ä¸‹å›¾ï¼š

![image-20231203224444915](.\asset\æ–‡ä»¶ä¸Šä¼ \1.æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ä½“.png)

ç»“åˆä»£ç ï¼Œè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“å¯çŸ¥ï¼Œåˆ›å»ºçš„`FormData` å¯¹è±¡ä½œä¸ºè¯·æ±‚ä½“è¿›è¡Œä¼ è¾“æ—¶ï¼Œä¼šå–å‡ºè¯·æ±‚å¤´ `Content-Type` å®šä¹‰çš„  `boundary` å±æ€§ï¼Œå†å…¶å¼€å¤´æ·»åŠ  `--` ä½œä¸ºåˆ†éš”ç¬¦å°† `FormData` å¯¹è±¡çš„å±æ€§åˆ’åˆ†å‡ºçš„ä¸åŒéƒ¨åˆ†ã€‚æ¯ä¸€éƒ¨åˆ†æœ‰è‡ªå·±çš„å®ä½“ï¼Œ[`Content-Disposition`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition) å’Œ [`Content-Type`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type) ç”¨äºæ–‡ä»¶ä¸Šä¼ å­—æ®µã€‚

## å‰ç«¯é¡µé¢                                                                                                                                                                                                                                                                                                                                                                                                                                           

æ€»ç»“ç›®å‰ä¸»è¦æµè¡Œçš„ ui æ¡†æ¶ï¼Œæ–‡ä»¶ä¸Šä¼ ç»„ä»¶ä¸­é€šå¸¸ä¼šæœ‰ä¸‰ç§çŠ¶æ€ï¼šå¾…ä¸Šä¼ ï¼Œä¸Šä¼ ä¸­ï¼Œä¸Šä¼ å®Œæˆã€‚

![image-20231203235006367](.\asset\æ–‡ä»¶ä¸Šä¼ \2.æ–‡ä»¶ä¸Šä¼ å‰ç«¯é¡µé¢.png)                                                                                                                                                                    

HTML å’Œ CSS ä»£ç åˆ™æ ¹æ®è¿™ä¸‰ç§çŠ¶æ€æ¥è¿›è¡Œåˆ‡æ¢ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```html
<style>
    .upload {
        position: relative;
    }
    .upload-select,
    .upload-progress,
    .upload-result,
    .upload > img {
        display: none;
        position: absolute;
    }

    .upload.select .upload-select,
    .upload.progress .upload-progress,
    .upload.result .upload-result {
        display: block;
    }

    .upload.select > img{
        display: none;
    }
    
    .upload.progress > img{
        display: block;
        z-index: -1;
    }  
    
    .upload.result > img{
        display: block;
    }     
</style>

<div class="upload select" id="upload-container">
    <div class="upload-select pointer" id="upload-select">
        <input type="file" name="file" class="upload__input" id="file">
    </div>
    <div class="upload-progress">
        <div class="progress-bar" style="--percent: 0%;" id="progress-bar">
            <button class="btn" id="upload-cancel">å–æ¶ˆ</button>
        </div>
    </div>
    <div class="upload-result">
        <button class="btn" id="upload-result">X</button>
    </div>
    <img src="./images/demo.jpg" alt="" srcset="" id="upload-img-preview">
</div>
```

ä¸‰ä¸ªçŠ¶æ€çš„æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20231228222959853](.\asset\æ–‡ä»¶ä¸Šä¼ \3.å‰ç«¯é¡µé¢.png)

## æ–‡ä»¶ä¸Šä¼ é€»è¾‘å’ŒåŸç†

æ ¹æ®é¡µé¢å˜åŒ–ï¼Œæ–‡ä»¶ä¸Šä¼ æ ¸å¿ƒæ­¥éª¤ä¹Ÿå¯åˆ†ä¸ºä¸‰æ­¥ï¼š

1. æ–‡ä»¶é€‰æ‹©ï¼šé€šè¿‡ `input[type="file"]` é€‰æ‹©éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå³ `file` å¯¹è±¡;
2. åœ¨çº¿é¢„è§ˆï¼šå¦‚æœæ˜¯å›¾ç‰‡è¿›è¡Œåœ¨çº¿é¢„è§ˆ;
3. æ¥å£è°ƒç”¨ï¼šè°ƒç”¨æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæä¾›ä¸Šä¼ å–æ¶ˆçš„åŠŸèƒ½ï¼›

**==æ–‡ä»¶é€‰æ‹©==**

æ–‡ä»¶é€‰æ‹©æ˜¯é€šè¿‡ `<input type="file">` å…ƒç´ æ¥å®Œæˆçš„ã€‚

> `input[type='file']` æœ‰ä¸‰ä¸ªé™„åŠ å±æ€§ï¼Œ[`accept`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#accept)ã€[`capture`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#capture) å’Œ [`multiple`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#multiple)ã€‚ 
>
> å½“æŒ‡å®šå¸ƒå°”ç±»å‹å±æ€§ [`multiple` (en-US)](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/multiple) æ—¶ï¼Œæ–‡ä»¶ input å…è®¸ç”¨æˆ·é€‰æ‹©å¤šä¸ªæ–‡ä»¶ã€‚
>
> [`accept` (en-US)](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/accept) å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒå®šä¹‰äº†æ–‡ä»¶ input åº”è¯¥æ¥å—çš„æ–‡ä»¶ç±»ã€‚è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªä»¥é€—å·ä¸ºåˆ†éš”çš„[**å”¯ä¸€æ–‡ä»¶ç±»å‹è¯´æ˜ç¬¦**](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#å”¯ä¸€æ–‡ä»¶ç±»å‹è¯´æ˜ç¬¦)åˆ—è¡¨ã€‚
>
> [`capture` (en-US)](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/capture) å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æœ [`accept` (en-US)](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/accept) å±æ€§æŒ‡å‡ºäº† input æ˜¯å›¾ç‰‡æˆ–è€…è§†é¢‘ç±»å‹ï¼Œåˆ™å®ƒæŒ‡å®šäº†ä½¿ç”¨å“ªä¸ªæ‘„åƒå¤´å»è·å–è¿™äº›æ•°æ®ã€‚å€¼ `user` è¡¨ç¤ºåº”è¯¥ä½¿ç”¨å‰ç½®æ‘„åƒå¤´å’Œï¼ˆæˆ–ï¼‰éº¦å…‹é£ã€‚å€¼ `environment` è¡¨ç¤ºåº”è¯¥ä½¿ç”¨åç½®æ‘„åƒå¤´å’Œï¼ˆæˆ–ï¼‰éº¦å…‹é£ã€‚

```html
<!--
å”¯ä¸€æ–‡ä»¶ç±»å‹è¯´æ˜ç¬¦æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºåœ¨ file ç±»å‹çš„ <input> å…ƒç´ ä¸­ç”¨æˆ·å¯ä»¥é€‰æ‹©çš„æ–‡ä»¶ç±»å‹ã€‚æ¯ä¸ªå”¯ä¸€æ–‡ä»¶ç±»å‹è¯´æ˜ç¬¦å¯ä»¥é‡‡ç”¨ä¸‹åˆ—å½¢å¼ä¹‹ä¸€ï¼š

1. ä¸€ä¸ªä»¥è‹±æ–‡å¥å·ï¼ˆâ€œ.â€ï¼‰å¼€å¤´çš„åˆæ³•çš„ä¸åŒºåˆ†å¤§å°å†™çš„æ–‡ä»¶åæ‰©å±•åã€‚ä¾‹å¦‚ï¼š.jpgã€.pdf æˆ– .docã€‚
2. ä¸€ä¸ªä¸å¸¦æ‰©å±•åçš„ MIME ç±»å‹å­—ç¬¦ä¸²ã€‚
3. å­—ç¬¦ä¸² audio/*ï¼Œè¡¨ç¤ºâ€œä»»ä½•éŸ³é¢‘æ–‡ä»¶â€ã€‚
4. å­—ç¬¦ä¸² video/*ï¼Œè¡¨ç¤ºâ€œä»»ä½•è§†é¢‘æ–‡ä»¶â€ã€‚
5. å­—ç¬¦ä¸² image/*ï¼Œè¡¨ç¤ºâ€œä»»ä½•å›¾ç‰‡æ–‡ä»¶â€ã€‚

ä¸‹é¢è¡¨ç¤ºæ¥å—ä»»ä½•å›¾ç‰‡å’ŒPDF
-->
<input type="file" accept="image/*,.pdf" />
```

é™¤äº†ä¸Šé¢åˆ—å‡ºæ¥çš„ä¸‰ä¸ªå±æ€§å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªéæ ‡å‡†å±æ€§ `webkitdirectory`

> å¦‚æœå‡ºç°å¸ƒå°”å±æ€§ `webkitdirectory`(æˆ–è€… mozdirectory odirectory)ï¼Œè¡¨ç¤ºåœ¨æ–‡ä»¶é€‰æ‹©å™¨ç•Œé¢ä¸­ç”¨æˆ·åªèƒ½é€‰æ‹©ç›®å½•ã€‚å¦‚æœè®¾ç½®ä¸º `true`ï¼Œåˆ™ [`input`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/input) å…ƒç´ åªå…è®¸é€‰æ‹©ç›®å½•ï¼›å¦‚æœè®¾ç½®ä¸º `false`ï¼Œåˆ™åªå…è®¸é€‰æ‹©æ–‡ä»¶ã€‚

```html
<!--å…è®¸ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªç›®å½•ï¼ˆæ–‡ä»¶å¤¹ï¼‰ -->
<input type="file" id="filepicker" name="fileList" webkitdirectory multiple />

<script>
document.getElementById("filepicker").addEventListener(
  "change",
  (event) => {
    let output = document.getElementById("listing");
    for (const file of event.target.files) {
      let item = document.createElement("li");
      item.textContent = file.webkitRelativePath;
      output.appendChild(item);
    }
  },
  false,
);
</script>
```

![image-20231231193318131](.\asset\æ–‡ä»¶ä¸Šä¼ \4.webkitdirectoryå…¼å®¹æ€§.png)

è¢«é€‰æ‹©çš„æ–‡ä»¶ä»¥ `HTMLInputElement.files` å±æ€§è¿”å›ï¼Œå®ƒæ˜¯åŒ…å«ä¸€ç³»åˆ— [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) å¯¹è±¡çš„ [`FileList`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileList) ç±»æ•°ç»„ã€‚

![image-20231231203553288](.\asset\æ–‡ä»¶ä¸Šä¼ \5.fileList.png)

æ¯ä¸ª `File`  å¯¹è±¡æ‹¥æœ‰6ä¸ªå±æ€§ï¼š

- [`name`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#name)ï¼šæ–‡ä»¶å
- [`lastModified`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#lastmodified)ï¼šä¸€ä¸ªæ•°å­—ï¼ŒæŒ‡å®šæ–‡ä»¶æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¥æœŸå’Œæ—¶é—´ï¼Œä»¥ UNIX æ–°çºªå…ƒï¼ˆ1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œï¼‰ä»¥æ¥çš„æ¯«ç§’æ•°è¡¨ç¤ºã€‚
- [`lastModifiedDate`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#lastmodifieddate) ï¼šä¸€ä¸ª [`Date`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Date) å¯¹è±¡ï¼Œè¡¨ç¤ºæ–‡ä»¶æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¥æœŸå’Œæ—¶é—´ã€‚*è¿™è¢«å¼ƒç”¨ï¼Œä½¿ç”¨ `lastModified` ä½œä¸ºæ›¿ä»£ã€‚*
- [`size`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#size)ï¼šä»¥å­—èŠ‚æ•°ä¸ºå•ä½çš„æ–‡ä»¶å¤§å°
- [`type`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#type)ï¼šæ–‡ä»¶çš„ [MIME ç±»å‹](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types)
- [`webkitRelativePath`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file#webkitrelativepath) ï¼šä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒæŒ‡å®šäº†ç›¸å¯¹äºåœ¨ç›®å½•é€‰æ‹©å™¨ä¸­é€‰æ‹©çš„åŸºæœ¬ç›®å½•çš„æ–‡ä»¶è·¯å¾„ï¼ˆå³ï¼Œä¸€ä¸ªè®¾ç½®äº† [`webkitdirectory`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/input/file#webkitdirectory) å±æ€§çš„ `file` é€‰æ‹©å™¨ï¼‰ã€‚*è¿™æ˜¯éæ ‡å‡†çš„ï¼Œè°¨æ…ä½¿ç”¨ã€‚*

`file` å¯¹è±¡çš„1ä¸ªæ–¹æ³•ï¼ˆç»§æ‰¿è‡ª `Blob` å¯¹è±¡ï¼‰ï¼š

-  [`Blob.slice(start, end, contentType)`](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob/slice)

  è¿”å›ä¸€ä¸ªæ–°çš„ `Blob` å¯¹è±¡ï¼Œå®ƒåŒ…å«æœ‰æº `Blob` å¯¹è±¡ä¸­æŒ‡å®šèŒƒå›´å†…çš„æ•°æ®ã€‚

****

**==åœ¨çº¿é¢„è§ˆ==**

ä½¿ç”¨ `input[type='file']` æ‹¿åˆ°äº† `file` å¯¹è±¡ï¼Œé€šè¿‡  [`FileReader`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader), [`URL.createObjectURL()`](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL_static) æ¥å¯ä»¥å¤„ç†äºŒè¿›åˆ¶çš„ Blob å¯¹è±¡ï¼Œå®Œæˆå›¾ç‰‡çš„åœ¨çº¿é¢„è§ˆã€‚

> **`FileReader`** å¯¹è±¡å…è®¸ Web åº”ç”¨ç¨‹åºå¼‚æ­¥è¯»å–å­˜å‚¨åœ¨ç”¨æˆ·è®¡ç®—æœºä¸Šçš„æ–‡ä»¶ï¼ˆæˆ–åŸå§‹æ•°æ®ç¼“å†²åŒºï¼‰çš„å†…å®¹ï¼Œä½¿ç”¨ [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) æˆ– [`Blob`](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob) å¯¹è±¡æŒ‡å®šè¦è¯»å–çš„æ–‡ä»¶æˆ–æ•°æ®ã€‚

FileReader æœ‰ä»¥ä¸‹3ä¸ªå±æ€§ï¼Œå‡ä¸ºåªè¯»ï¼š

- [`FileReader.error`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/error) ï¼šä¸€ä¸ª[`DOMException`](https://developer.mozilla.org/zh-CN/docs/Web/API/DOMException)ï¼Œè¡¨ç¤ºåœ¨è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿçš„é”™è¯¯ã€‚
- [`FileReader.readyState`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readyState) ï¼šè¡¨ç¤º`FileReader`çŠ¶æ€çš„æ•°å­—ã€‚
- [`FileReader.result`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/result) ï¼šæ–‡ä»¶çš„å†…å®¹ã€‚è¯¥å±æ€§ä»…åœ¨è¯»å–æ“ä½œå®Œæˆåæ‰æœ‰æ•ˆï¼Œæ•°æ®çš„æ ¼å¼å–å†³äºä½¿ç”¨å“ªä¸ªæ–¹æ³•æ¥å¯åŠ¨è¯»å–æ“ä½œã€‚

```js
const file = HTMLInputElement.files[0];
const reader = new FileReader();
console.log("ğŸš€ ~ EMPTY:", reader.readyState) // 0:è¿˜æ²¡æœ‰åŠ è½½ä»»ä½•æ•°æ®
reader.readAsDataURL(file);
console.log("ğŸš€ ~ LOADING:", reader.readyState) // 1:æ•°æ®æ­£åœ¨è¢«åŠ è½½
reader.onloadend = () => {
    console.log("ğŸš€ ~ DONE:", reader.readyState)// 2:å·²å®Œæˆå…¨éƒ¨çš„è¯»å–è¯·æ±‚
    selectors.imgPreview.src = reader.result;
}
```

å¸¸ç”¨çš„äº‹ä»¶å¤„ç†ï¼š

- [`FileReader.onabort`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/abort_event)ï¼šå¤„ç† [`abort`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/abort_event) äº‹ä»¶ã€‚è¯¥äº‹ä»¶åœ¨è¯»å–æ“ä½œè¢«ä¸­æ–­æ—¶è§¦å‘ã€‚ 
- [`FileReader.onerror`](https://developer.mozilla.org/en-US/docs/Web/API/FileReader/error_event)ï¼šå¤„ç† [`error`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/error_event) äº‹ä»¶ã€‚è¯¥äº‹ä»¶åœ¨è¯»å–æ“ä½œå‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
- [`FileReader.onload`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/load_event)ï¼šå¤„ç† [`load`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/load_event) äº‹ä»¶ã€‚è¯¥äº‹ä»¶åœ¨è¯»å–æ“ä½œå®Œæˆæ—¶è§¦å‘ã€‚

å¸¸ç”¨çš„æ–¹æ³•ï¼š

- [`FileReader.readAsDataURL()`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsDataURL)ï¼šå¼€å§‹è¯»å–æŒ‡å®šçš„[`Blob`](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob)ä¸­çš„å†…å®¹ã€‚ä¸€æ—¦å®Œæˆï¼Œ`result` å±æ€§ä¸­å°†åŒ…å«ä¸€ä¸ª`data:` URL æ ¼å¼çš„ Base64 å­—ç¬¦ä¸²ä»¥è¡¨ç¤ºæ‰€è¯»å–æ–‡ä»¶çš„å†…å®¹ã€‚
- [`FileReader.readAsText()`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsText)ï¼šå¼€å§‹è¯»å–æŒ‡å®šçš„[`Blob`](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob)ä¸­çš„å†…å®¹ã€‚ä¸€æ—¦å®Œæˆï¼Œ`result`å±æ€§ä¸­å°†åŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²ä»¥è¡¨ç¤ºæ‰€è¯»å–çš„æ–‡ä»¶å†…å®¹ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ä»£ç å®ç°ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤

```html
<div class="upload select" id="upload-container">
    <div class="upload-select pointer" id="upload-select" draggable>
        <input type="file" name="file" class="upload__input" id="file">
    </div>
    <div class="upload-progress">
        <div class="progress-bar" style="--percent: 0%;" id="progress-bar">
            <button class="btn" id="upload-cancel">å–æ¶ˆ</button>
        </div>
    </div>
    <div class="upload-result">
        <button class="btn" id="upload-result">X</button>
    </div>
    <img src="./images/demo.jpg" alt="" srcset="" id="upload-img-preview">
</div>
```

```js
const $ = document.querySelector.bind(document);

const UPLOADPHASENUMS = {
    select: 'select',
    progress: 'progress',
    result: 'result',
}

// å…ƒç´ é€‰æ‹©å™¨å¯¹è±¡
const selectors = {
    container: $("#upload-container"),
    file: $("#file"),
    upload: $("#upload-select"),
    progressBar: $("#progress-bar"),
    result: $("#upload-result"),
    imgPreview: $("#upload-img-preview"),
    cancel: $("#upload-cancel"),
}

// æ›´æ”¹é¡µé¢å…ƒç´ çš„æ˜¾ç¤º
function setPhase(phase) {
    selectors.container.className = `upload ${phase}`;
}

// è§¦å‘ input[type='file'] çš„ç‚¹å‡»äº‹ä»¶
selectors.upload.addEventListener('click', () => {
    selectors.file.click();
})

selectors.result.addEventListener('click', () => {
    setPhase(UPLOADPHASENUMS.select);
})

selectors.cancel.addEventListener('click', () => {
    setPhase(UPLOADPHASENUMS.select);
    uploadCtr.cancelFn();
})

const uploadCtr = {
    index: 0,
    total: 1,
    cancelFn: null
}
selectors.file.addEventListener('change',  () => {
    Array.from(selectors.file.files).forEach((file, index) => {
        fileChangeHandler(file)
    })
});

async function fileChangeHandler(file) {
    setPhase(UPLOADPHASENUMS.progress)
    imagePreview(file, selectors.imgPreview)
    uploadCtr.cancelFn = 
        uploadAjax(
        	file,
            (percent) => {
                selectors.progressBar.style = `--percent:${percent * 100}%;`
            },
            (result) => {
				console.log("ä¸Šä¼ æˆåŠŸ",result);
            }
        );
}    
function imagePreview(file, selector) {
    // æ–‡ä»¶é¢„è§ˆ
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = () => {
        selector.src = reader.result;
    }
}
/**
 * @description: ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
 * @param {*} file
 * @param {*} onProgress ä¸Šä¼ è¿‡ç¨‹ä¸­æ‰§è¡Œçš„å›è°ƒ
 * @param {*} onFinish ä¸Šä¼ å®Œæˆåæ‰§è¡Œçš„å›è°ƒ
 * @return {*}
 */
function uploadAjax(file, onProgress, onFinish) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('fileName', file.name);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://localhost:8080/upload');
    xhr.addEventListener("readystatechange", () => {
        if (xhr.readyState === 4 && xhr.status === 200) {
            onFinish(JSON.parse(xhr.responseText));
        }
    })
    xhr.addEventListener("progress", (e) => {
        let percent = (uploadCtr.index + e.loaded / e.total) / uploadCtr.total;
        onProgress(percent);
    })
    xhr.send(formData);
    return () => {
        xhr.abort();
    }
}
```

## ä¸åŒçš„ä¸Šä¼ åœºæ™¯

### å¤šæ–‡ä»¶(å¤¹)ä¸Šä¼ 

å¯¹äºå¤šæ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä¸Šä¼ éœ€æ±‚ï¼Œå€ŸåŠ©çš„å°±æ˜¯ `input[type='file']` çš„ `multiple` å’Œ `webkitdirectory` å±æ€§ã€‚

```html
<input type="file" multiple webkitdirectory />
```

æ–‡ä»¶å¤¹ä¸Šä¼ æ¼”ç¤ºï¼š

![image-20240101114333728](.\asset\æ–‡ä»¶ä¸Šä¼ \6.æ–‡ä»¶å¤¹ä¸Šä¼ .png)

å¯¹äºæ”¯æŒ `webkitdirectory` å±æ€§ï¼Œå¾—åˆ°çš„ç»“æœå°†åŒ…æ‹¬è¯¥æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ï¼Œæ‰“å° `HTMLInputElement.files` ç»“æœå¦‚ä¸‹ï¼š

![image-20240101115429296](.\asset\æ–‡ä»¶ä¸Šä¼ \7.æ–‡ä»¶å¤¹ä¸Šä¼ ç»“æœ.png)

åœ¨å®é™…å¼€å‘ä¸­é€šå¸¸æ˜¯ä¼šéšè— `input` å…ƒç´ ï¼Œé€šè¿‡ `HTMLInputElement.click()` æ‰‹åŠ¨è§¦å‘  `input` å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶ã€‚

### æ‹–æ‹½ä¸Šä¼ 

æ–¹å¼ä¸€ï¼š

 `input[type='file']`  æ ‡ç­¾æ˜¯æ”¯æŒæ‹–æ‹½ï¼Œå°†è¦ä¸Šä¼ çš„æ–‡ä»¶æ‹–æ‹½åˆ° `input` å…ƒç´ åï¼Œç›‘å¬ `change` äº‹ä»¶åèƒ½æ‹¿åˆ° `FileList` å¯¹è±¡ã€‚

![image-20240101125938704](.\asset\æ–‡ä»¶ä¸Šä¼ \8.æ‹–æ‹½ä¸Šä¼ ç¤ºä¾‹.png)

ä½¿ç”¨è¿™ç§æ–¹å¼åªéœ€è¦å°† `input` å…ƒç´  `opacity:0` 

```html
<style>
.upload__input {
    opacity: 0;
    width: 100%;
    height: 100%;
}
</style>
<div class="upload-select" id="upload-select">
     <input type="file" name="file" class="upload__input" id="file" webkitdirectory>
</div>
```

æ–¹å¼äºŒï¼š

åœ¨å®é™…å¼€å‘ä¸­é€šå¸¸æ˜¯ä¼šéšè— `input` å…ƒç´ ï¼Œä½¿ç”¨ `div` è‡ªå®šä¹‰ä¸Šä¼ çš„æ ·å¼ï¼Œå¯¹äºè¿™ç§æƒ…å†µå°±éœ€è¦é€šè¿‡ HTML æ‹–æ”¾ API æ¥å®ç°ã€‚

å’Œæ‹–æ‹½ä¸Šä¼ ç›¸å…³çš„æ‹–æ‹½äº‹ä»¶æœ‰ä¸‰ä¸ªï¼Œ`dragover`,`dragenter`,`drop` äº‹ä»¶ï¼Œ`dragover`,`dragenter` éœ€è¦é˜»æ­¢é»˜è®¤äº‹ä»¶æ‰èƒ½è§¦å‘ `drop` äº‹ä»¶ã€‚

é€šè¿‡ç›‘å¬ `div` å…ƒç´ çš„ `drop` äº‹ä»¶ , é€šè¿‡ `DragEvent.dataTransfer` å±æ€§èƒ½æ‹¿åˆ°æ‰˜æ‹½æ“ä½œä¸­çš„æ•°æ®ã€‚`DataTransfer` æœ‰5ä¸ªå¦‚ä¸‹æ ‡å‡†å±æ€§ï¼š

- [`DataTransfer.dropEffect`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer/dropEffect)ï¼šè·å–å½“å‰é€‰å®šçš„æ‹–æ”¾æ“ä½œç±»å‹æˆ–è€…è®¾ç½®çš„ä¸ºä¸€ä¸ªæ–°çš„ç±»å‹ã€‚å€¼å¿…é¡»ä¸º `none`, `copy`, `link` æˆ– `move`ã€‚
- [`DataTransfer.effectAllowed`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer/effectAllowed)ï¼šæä¾›æ‰€æœ‰å¯ç”¨çš„æ“ä½œç±»å‹ã€‚å¿…é¡»æ˜¯ `none`, `copy`, `copyLink`, `copyMove`, `link`, `linkMove`, `move`, `all` or `uninitialized` ä¹‹ä¸€ã€‚
- [`DataTransfer.files`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer/files)ï¼šåŒ…å«æ•°æ®ä¼ è¾“ä¸­å¯ç”¨çš„æ‰€æœ‰æœ¬åœ°æ–‡ä»¶çš„åˆ—è¡¨ã€‚å¦‚æœæ‹–åŠ¨æ“ä½œä¸æ¶‰åŠæ‹–åŠ¨æ–‡ä»¶ï¼Œåˆ™æ­¤å±æ€§ä¸ºç©ºåˆ—è¡¨ã€‚
- [`DataTransfer.items`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer/items) ï¼šåªè¯»ï¼Œæä¾›ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ‹–åŠ¨æ•°æ®åˆ—è¡¨çš„ [`DataTransferItemList`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItemList) ç±»æ•°ç»„å¯¹è±¡ï¼ŒåŒ…å«äº†è¡¨ç¤ºæ‹–åŠ¨æ“ä½œä¸­è¢«æ‹–åŠ¨é¡¹çš„[`DataTransferItem`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem)å¯¹è±¡ã€‚
- [`DataTransfer.types`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer/types) ï¼šåªè¯»ï¼Œä¸€ä¸ªæä¾› [`dragstart`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/dragstart_event) äº‹ä»¶ä¸­è®¾ç½®çš„æ ¼å¼çš„ [`strings`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String) æ•°ç»„ã€‚

![image-20240101151059068](.\asset\æ–‡ä»¶ä¸Šä¼ \9.DataTransferå±æ€§.png)

> `File` å¯¹è±¡é™¤äº†æ¥è‡ªç”¨æˆ·åœ¨ä¸€ä¸ª [`input`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/input) å…ƒç´ ä¸Šé€‰æ‹©æ–‡ä»¶åè¿”å›çš„ [`FileList`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileList) å¯¹è±¡å¤–ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥è‡ªç”±æ‹–æ”¾æ“ä½œç”Ÿæˆçš„ [`DataTransfer`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer) å¯¹è±¡ï¼Œæˆ–è€…æ¥è‡ª [`HTMLCanvasElement`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement) ä¸Šçš„ `mozGetAsFile`() APIã€‚

é€šè¿‡ `DataTransfer.files` å±æ€§å¯ä»¥æ‹¿åˆ° `FileList` å¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœæ˜¯æ–‡ä»¶å¤¹æ‹¿åˆ°çš„åªæ˜¯æ–‡ä»¶å¤¹çš„ä¿¡æ¯è€Œä¸æ˜¯æ–‡ä»¶ã€‚

é’ˆå¯¹æ–‡ä»¶å¤¹è¿™ç§åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ `DataTransferItem` æ¥è·å–æ–‡ä»¶

`DataTransferItem` çš„ 2ä¸ªå±æ€§ï¼š

- [`DataTransferItem.kind`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem/kind) åªè¯»ï¼Œæ‹½é¡¹çš„ç§ç±»ï¼Œ`string` æˆ–æ˜¯ `file`ã€‚
- [`DataTransferItem.type`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem/type) åªè¯»ï¼Œæ‹–æ‹½é¡¹çš„ç±»å‹ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ª MIME ç±»å‹ã€‚

`DataTransferItem` çš„3ä¸ªæ–¹æ³•ï¼š

- [`DataTransferItem.getAsFile()`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem/getAsFile)ï¼šè¿”å›ä¸€ä¸ªå…³è”æ‹–æ‹½é¡¹çš„ [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) å¯¹è±¡ï¼ˆå½“æ‹–æ‹½é¡¹ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶æ—¶è¿”å› nullï¼‰ã€‚
- [`DataTransferItem.getAsString()`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem/getAsString)ï¼šä½¿ç”¨æ‹–æ‹½é¡¹çš„å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°æ‰§è¡ŒæŒ‡å®šå›è°ƒå‡½æ•°ã€‚
- [`DataTransferItem.webkitGetAsEntry()`](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem/webkitGetAsEntry) éæ ‡å‡†ï¼Œè¿”å›ä¸€ä¸ªåŸºäº [`FileSystemEntry` (en-US)](https://developer.mozilla.org/en-US/docs/Web/API/FileSystemEntry) çš„å¯¹è±¡æ¥è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿä¸­é€‰ä¸­çš„é¡¹ç›®ã€‚é€šå¸¸æ˜¯è¿”å›ä¸€ä¸ª[`FileSystemFileEntry`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileSystemFileEntry) æˆ–æ˜¯ [`FileSystemDirectoryEntry`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileSystemDirectoryEntry) å¯¹è±¡ã€‚`FileSystemDirectoryEntry` ä»å®ƒçš„çˆ¶æ¥å£ [`FileSystemEntry` (en-US)](https://developer.mozilla.org/en-US/docs/Web/API/FileSystemEntry) ç»§æ‰¿äº†æ–¹æ³•[`createReader()` (en-US)](https://developer.mozilla.org/en-US/docs/Web/API/FileSystemDirectoryEntry/createReader)ï¼Œå®ƒå¯ä»¥ç”¨äºè¯»å–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚`FileSystemFileEntry` ä»å®ƒçš„çˆ¶æ¥å£ [`FileSystemEntry` (en-US)](https://developer.mozilla.org/en-US/docs/Web/API/FileSystemEntry) ç»§æ‰¿äº†æ–¹æ³•[`file()` (en-US)](https://developer.mozilla.org/en-US/docs/Web/API/FileSystemFileEntry/file)åˆ›å»ºæ–°çš„ [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) å¯¹è±¡ï¼Œå®ƒå¯ä»¥ç”¨äºè¯»å–æ–‡ä»¶ã€‚

> æ­¤åŠŸèƒ½`webkitGetAsEntry()`åœ¨æ­¤æ—¶éåŒ…å« Firefox çš„é WebKit æµè§ˆå™¨ä¸­å®ç°; å®ƒå¯èƒ½ä¼š`getAsEntry()`åœ¨ä»¥åç®€å•åœ°é‡å‘½åï¼Œæ‰€ä»¥ä½ åº”è¯¥è¿›è¡Œé˜²å¾¡æ€§ç¼–ç ï¼Œå¯»æ‰¾ä¸¤è€…ã€‚

```html
<div class="upload-select pointer" id="upload-select">
    <input type="file" name="file" class="upload__input" id="file" multiple 
    webkitdirectory mozdirectory odirectory>
</div>
<script>
const $ = document.querySelector.bind(document);
    
const selectors = {
    container: $("#upload-container"),
    file: $("#file"),
    upload: $("#upload-select"),
    progressBar: $("#progress-bar"),
    result: $("#upload-result"),
    imgPreview: $("#upload-img-preview"),
    cancel: $("#upload-cancel"),
}

function setPhase(phase) {
    selectors.container.className = `upload ${phase}`;
}

selectors.upload.addEventListener('click', () => {
    selectors.file.click();
})

selectors.upload.addEventListener("dragenter", (e) => {
    e.preventDefault();
})

selectors.upload.addEventListener("dragover", (e) => {
    e.preventDefault();
})

selectors.upload.addEventListener("drop", async (e) => {
    e.preventDefault();
    uploadFiles(e.dataTransfer);
})
    
async function uploadFiles(dataTransfer) {
    function _uploadFiles(entry) {
        if (entry.isDirectory) {
            // ç›®å½•
            const reader = entry.createReader();
            reader.readEntries((entries) => {
                entries.forEach(async (en) => {
                    _uploadFiles(en);
                })
            })
        } else {
            entry.file((file) => {
                // æ–‡ä»¶
                fileChangeHandler(file);
            })
        }
    }
    for (const item of dataTransfer.items) {
        const entry = item.getAsEntry ? item.getAsEntry() : item.webkitGetAsEntry();
        _uploadFiles(entry);
    }
}
</script>
```

### è£å‰ªä¸Šä¼ 

æ–‡ä»¶çš„è£å‰ªä¸Šä¼ éœ€è¦ä½¿ç”¨åˆ° `canvas` çš„ [`CanvasRenderingContext2D.drawImage()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/drawImage) è¿›è¡Œå›¾ç‰‡çš„è£å‰ªï¼Œè£å‰ªåé€šè¿‡ [`HTMLCanvasElement.toBlob()`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement/toBlob) å¾—åˆ° `Blob` å¯¹è±¡ï¼Œé€šè¿‡ `new File([Blob])`  å¾—åˆ° `file` å¯¹è±¡ã€‚

å…³äº `drawImage` çš„ä½¿ç”¨å¯ä»¥å‚ç…§ [ä»0å¼€å§‹canvasç³»åˆ—äºŒ --- æ–‡æœ¬å’Œå›¾åƒ](https://juejin.cn/post/6877164274817597447#heading-12)

`toBlob` æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°æ— è¿”å›å€¼ï¼Œå‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š

```js
toBlob(callback, type, quality)
/**
callback:å›è°ƒå‡½æ•°ï¼Œå¯è·å¾—ä¸€ä¸ªå•ç‹¬çš„ Blob å¯¹è±¡å‚æ•°ã€‚å¦‚æœå›¾åƒæœªè¢«æˆåŠŸåˆ›å»ºï¼Œå¯èƒ½ä¼šè·å¾— null å€¼ã€‚
type:å¯é€‰,DOMString ç±»å‹ï¼ŒæŒ‡å®šå›¾ç‰‡æ ¼å¼ï¼Œé»˜è®¤æ ¼å¼ï¼ˆæœªæŒ‡å®šæˆ–ä¸æ”¯æŒï¼‰ä¸º image/pngã€‚
quality :å¯é€‰,Number ç±»å‹ï¼Œå€¼åœ¨ 0 ä¸ 1 ä¹‹é—´ï¼Œå½“è¯·æ±‚å›¾ç‰‡æ ¼å¼ä¸º image/jpeg æˆ–è€… image/webp æ—¶ç”¨æ¥æŒ‡å®šå›¾ç‰‡å±•ç¤ºè´¨é‡ã€‚å¦‚æœè¿™ä¸ªå‚æ•°çš„å€¼ä¸åœ¨æŒ‡å®šç±»å‹ä¸èŒƒå›´ä¹‹å†…ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼Œå…¶ä½™å‚æ•°å°†è¢«å¿½ç•¥ã€‚
**/
```

ä»¥ä¸‹æ˜¯ä¸€ä¸ªdemoæ¡ˆä¾‹ï¼ŒåŠŸèƒ½æ˜¯ä¸Šä¼ æ–‡ä»¶åé¢„è§ˆï¼Œç‚¹å‡»å›¾ç‰‡è£å‰ªæŒ‰é’®åå¾—åˆ°è£å‰ªåçš„ file å¯¹è±¡ï¼Œæœ€åè°ƒç”¨ä¸Šä¼ æ¥å£

```html
<div class="test-container">
    <input type="file" id="test1"/>
    <img src="./images/demo.jpg" alt="" srcset="" id="upload-test-img-preview">
    <div>
        <button id="clip">å›¾ç‰‡è£å‰ª</button>
    </div>
    <canvas id="clip-canvas"></canvas>
</div>
<script>
$("#test1").addEventListener('change', (e) => {
    console.log(e, e.target.files);
    imagePreview(e.target.files[0], $("#upload-test-img-preview"))
})
$('#clip').addEventListener('click',async () => {
    const clipOption = {
        cutWidth: 200,
        cutHeight: 200,
        cutX: 50,
        cutY: 50,
        width: 100,
        height: 100,
    }
    const file =await clipImageData($('#upload-test-img-preview'), clipOption);
    fileChangeHandler(file);
})
// å›¾ç‰‡è£å‰ª    
function clipImageData(imgEle, clipOption) {
    const {
        cutWidth,
        cutHeight,
        cutX,
        cutY,
        width,
        height,
    } = clipOption;

    const canvas = $('#clip-canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(imgEle,
        cutX, cutY,
        cutWidth, cutHeight,
        0, 0,
        width, height
    );
    return new Promise(resolve=>{
        canvas.toBlob(blob => {
            const file = new File([blob], 'test.jpg', {
                type: "image/jpeg",
            });
            resolve(file);
        }, "image/jpeg")
    })
}
</script>
```



### åˆ‡ç‰‡ä¸Šä¼ 

æ–‡ä»¶çš„åˆ‡ç‰‡ä¸Šä¼ æœ¬è´¨ä¸Šæ˜¯å°†æ–‡ä»¶æŒ‰ç…§æŒ‡å®šå¤§å°åˆ‡åˆ†æˆå°çš„æ–‡ä»¶å—ï¼Œå¯ä»¥é€šè¿‡ `file` å¯¹è±¡çš„ `slice` æ–¹æ³•æ¥å®Œæˆï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
// æ–‡ä»¶åˆ‡ç‰‡
function sliceFile(file, size) {
    const fileChuckList = [];
    let curSize = 0;
    let fileSize = file.size;
    while (curSize <= fileSize) {
        let end = (curSize + size <= fileSize) ? (curSize + size) : fileSize;
        fileChuckList.push(file.slice(curSize, end));
        curSize += size;
    }
    return fileChuckList;
}

const uploadCtr = {
    index: 0,
    total: 0,
    cancelFn: null,
    mode: '', // 'slice' or 'file'
    sliceSize: 1024 * 2, // 1MB
}
selectors.file.addEventListener('change', () => {
    Array.from(selectors.file.files).forEach((file, index) => {
        fileChangeHandler(file)
    })
});

async function fileChangeHandler(file) {
    setPhase(UPLOADPHASENUMS.progress)
    imagePreview(file, selectors.imgPreview)
    if (uploadCtr.mode === 'slice') {
        fileUpload(file, uploadCtr.sliceSize);
    } else {
        fileUpload(file);
    }
}

async function fileUpload(file, sliceSize) {
    sliceSize = sliceSize || file.size;
    const fileChuckList = sliceFile(file, sliceSize);
    const fileHashObj = await getFileHash(fileChuckList);
    uploadCtr.total = fileChuckList.length;
    function _upload(i) {
        const file = {
            fileChuck: fileChuckList[i],
            fileChuckHash: fileHashObj.fileChucks[i],
            fileHash: fileHashObj.fileHash,
            isCompleted: i >= fileChuckList.length - 1
        }
        if (i >= fileChuckList.length) {
            setPhase(UPLOADPHASENUMS.result);
            return;
        }
        uploadCtr.cancelFn = uploadAjax(file,
            (percent) => {
                selectors.progressBar.style = `--percent:${percent * 100}%;`
            },
            (result) => {
                uploadCtr.index = i + 1;
                _upload(i + 1);
            }
        )
    }
    _upload(0)
}
// è®¡ç®—æ¯ä¸ªæ–‡ä»¶å—çš„ hash å€¼
function getFileHash(fileChuckList) {
    return new Promise((resolve) => {
        const fileHash = {
            file: '',
            fileChucks: []
        }
        const spark = new SparkMD5();
        function _read(i) {
            if (i >= fileChuckList.length) {
                fileHash.file = spark.end();
                resolve(fileHash);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const bytes = e.target.result;
                fileHash.fileChucks.push(SparkMD5.ArrayBuffer.hash(bytes))
                spark.append(bytes);
                _read(i + 1);
            }
            reader.readAsArrayBuffer(fileChuckList[i]);
        }
        _read(0);
    })
}

function uploadAjax(file, onProgress, onFinish) {
    const formData = new FormData();
    formData.append('fileChuck', file.fileChuck);
    formData.append('fileChuckHash', file.fileChuckHash);
    formData.append('fileHash', file.fileHash);
    formData.append('isCompleted', file.isCompleted)
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://localhost:8080/upload');
    xhr.addEventListener("readystatechange", () => {
        if (xhr.readyState === 4 && xhr.status === 200) {
            onFinish(JSON.parse(xhr.responseText));
        }
    })
    xhr.addEventListener("progress", (e) => {
        let percent = (uploadCtr.index + e.loaded / e.total) / uploadCtr.total;
        onProgress(percent);
    })
    xhr.send(formData);
    return () => {
        xhr.abort();
    }
}
```

 